```{r libraries, echo = FALSE, message = FALSE}
# load libraries and any relevant data here
library(tidyverse)

recs <- readRDS("../data/recs_2015_cleaned.RDS")
```

## Question 1

What impacts residential energy use across different cities and states?

In this section: investigating differences in total energy use between metropolitan and rural regions, different types of houses, different home ages, heating behavior, equipment usage, and geographic region. Graphs have not been styled.

```{r fig-btu-metromicro}
recs %>% 
  ggplot(aes(x = METROMICRO, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()
```

```{r fig-btu-huq}
recs %>% 
  ggplot(aes(x = housing_type, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))
```
```{r fig-btu-year-made}
recs$yearmade <- factor(recs$yearmade, levels = c(
  "Before 1950", "1950 to 1959", "1960 to 1969", "1970 to 1979", "1980 to 1989", "1990 to 1999", "2000 to 2009", "2010 to 2015"
))
recs %>% 
  ggplot(aes(x = yearmade, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))
```
```{r fig-btu-home-heat}
# does the home use space heating
recs %>% 
  ggplot(aes(x = homeheat, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()
```

```{r fig-btu-equipment-used}
recs %>% 
  ggplot(aes(x = equip_used_short, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal() 

recs %>% 
  filter(!is.na(equip_used_short)
         # equip_used_short != "No control"
         ) %>% 
  ggplot(aes(x = equip_used_short, y = TOTALBTU)) +
  geom_boxplot() +
  facet_wrap(vars(housing_type)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90))
```
We see in the initial graph that surprisingly, homes where the residents do not have control over their heating appear to use lower energy. When we disaggregate this variable by home type, however, this does not appear to be universally true. 

```{r}
# want: percentage of no-control homes that are also apartments
recs %>% 
  group_by(equip_used_short, housing_type) %>% 
  summarize(n = n())

```
With a closer look at the data, we find that a relatively small proportion of households have no control over their equipment use, and of that proportion, over half live in large apartment buildings, which tend to have lower overall energy use. Our surprisingly low energy use for "no control" homes can thus be attributed to this correlation. If we disregard the "no control" and "NA" 

```{r fig-region-home-heat}
recs %>% 
  ggplot(aes(x = region_name, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()

recs %>% 
  ggplot(aes(x = region_name, y = TOTALBTU)) +
  geom_boxplot() +
  facet_wrap(vars(homeheat)) +
  theme_minimal()
```

If we want to dive into regional differences, it might be useful to look at variables tracking cold, heat, and energy use for climate control. Might also be helpful to look at some general breakdowns of where this energy use comes from, but that might be difficult given how many factors there are. 

# April 4: Investigating housing type differences

Where does the difference in energy use between single family and multifamily housing come from?

- square footage
energy use per square foot by housing type

```{r}
# calculate energy use per sq ft
recs %>% 
  mutate(
    btu_per_sqft = TOTALBTU/TOTSQFT_EN
  ) %>% 
  ggplot(aes(x = housing_type, y = btu_per_sqft)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))
  
```

- elec vs ng
```{r}
recs %>% 
  ggplot(aes(x = housing_type, y = BTUEL)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))

recs %>% 
  ggplot(aes(x = housing_type, y = BTUNG)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))
```
Interesting: mobile homes tend to use much more electricity than ng, but still use ng. I wonder what they use it for.

```{r}
recs %>% 
  filter(housing_type == "Mobile home",
         BTUNG != 0) %>% 
  group_by(ng_warm, ng_water) %>% 
  summarise(n = n())
```

- adequate insulation
- household income

```{r}
recs$hh_income <- factor(recs$hh_income, levels = c(
  "Less than $20,000", "$20,000 - $39,999", "$40,000 - $59,999", "$60,000 to $79,999", "$80,000 to $99,999", "$100,000 to $119,999", "$120,000 to $139,999", "$140,000 or more"
))

recs %>% 
  ggplot(aes(x = hh_income, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))
```

```{r}
recs %>% 
  ggplot(aes(x = TOTSQFT_EN, y = TOTALBTU, color = hh_income)) +
  geom_point() +
  geom_smooth(method = lm) +
  theme_minimal() 

recs %>% 
  ggplot(aes(x = TOTSQFT_EN, y = TOTALBTU, color = housing_type)) +
  geom_point() +
  geom_smooth(method = lm) +
  theme_minimal() 
```
```{r}
recs$hh_income <- factor(recs$hh_income, levels = c(
  "Less than $20,000", "$20,000 - $39,999", "$40,000 - $59,999", "$60,000 to $79,999", "$80,000 to $99,999", "$100,000 to $119,999", "$120,000 to $139,999", "$140,000 or more"
))

recs %>% 
  mutate(
    btu_per_sqft = TOTALBTU/TOTSQFT_EN
  ) %>% 
  ggplot(aes(x = hh_income, y = btu_per_sqft)) +
  geom_boxplot() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 10))
```

It all comes down to square footage! Build smaller homes!

```{r}
recs %>% 
  ggplot(aes(x = TOTSQFT_EN, y = TOTALBTU)) +
  geom_point() +
  geom_smooth(method = lm) +
  theme_minimal() 

recs %>% 
  filter(sqft_cooled != 0) %>% 
  ggplot(aes(x = sqft_cooled, y = TOTALBTU)) +
  geom_point() +
  geom_smooth(method = lm) +
  theme_minimal() 

recs %>% 
  filter(sqft_warmed != 0) %>% 
  ggplot(aes(x = sqft_warmed, y = TOTALBTU)) +
  geom_point() +
  geom_smooth(method = lm) +
  theme_minimal()
```


```{r}
variables = cbind(recs$TOTSQFT_EN, recs$sqft_cooled, recs$sqft_warmed)
lin_mod_results = vector("list", 3)
for (i in 1:3){
  var = variables[,i]
  lin_mod_results[[i]] <- lm(TOTALBTU ~ var, data = recs)
}

purrr::map(lin_mod_results, summary)
# find that total sqft is a better predictor than either sqft_cooled or sqft_warmed

# just to check: remove 0s from sqft_cooled, see if it's more or less accurate
# lm_cooled <- recs %>% 
#   filter(sqft_cooled != 0) %>% 
#   lm(TOTALBTU ~ sqft_cooled, data = .)
# 
# summary(lm_cooled)
# results are not significantly different 
```

This linear model exploration finds that, based on $r^2$ scores, total square feet is a better predictor of energy use than the amount of square feet that are cooled or warmed in the building. Further analysis might investigate the impact of grouping variables on this model.

# The influence of smart energy programs and interventions

- audit
happened and changes made

```{r}
recs %>% 
  ggplot(aes(x = audit, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()

recs %>% 
  filter(audit == "Yes") %>% 
  ggplot(aes(x = audit_change, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()
```

- smart meter
start with if exists

```{r}
recs %>% 
  ggplot(aes(x = smart_meter, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()

recs %>% 
  filter(smart_meter == "Yes") %>% 
  ggplot(aes(x = smart_meter_viewed, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()
```

- energy assistance program 
not necessarily causal

```{r}
recs$hh_income <- factor(recs$hh_income, levels = c(
  "Less than $20,000", "$20,000 - $39,999", "$40,000 - $59,999", "$60,000 to $79,999", "$80,000 to $99,999", "$100,000 to $119,999", "$120,000 to $139,999", "$140,000 or more"
))

recs %>% 
  ggplot(aes(x = hh_income, y = TOTALBTU)) +
  facet_wrap(vars(energy_asst_prgm)) +
  geom_boxplot() +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45))

recs %>% 
  ggplot(aes(x = energy_asst_prgm, y = TOTALBTU)) +
  geom_boxplot() +
  theme_minimal()
```

