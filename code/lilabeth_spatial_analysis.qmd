---
title: "Building Energy Spatial Viz"
format: html
editor: visual
---

```{r, message=FALSE}
library(tidyverse)
library(sf) 
library(terra)
library(tigris)
library(purrr)
library(ggpubr)
```

```{r}
recs <- readRDS("../data/recs_2015_cleaned.RDS")
```

```{r}
acs <- readRDS("../data/acs_2015_cleaned.RDS")
```



```{r}
# set centers for mapping graduated symbols
centers <- st_centroid(acs, of_largest_polygon = TRUE)
```


```{r message=FALSE}
# Count housing type by geographic region
recs_housing_type <- recs %>%
  count(region_name, housing_type)

# Get the geometry from ACS data to join to RECS
region_geometry <- acs %>%
  group_by(region) %>%
  select(-GEOID,-NAME) %>%
  summarise_all(mean) %>%
  select(region, geometry)

# Join ACS geometry to RECS counts by region
recs_housing_spatial <- region_geometry %>%
  left_join(recs_housing_type, join_by(region == region_name)) %>%
  group_by(region) %>%
  mutate(totalHousing = sum(n),
         typeProportion = n / totalHousing)
```

# What is the RECS distribution of types of housing by region?

```{r}
# Map proportion of types of homes
map_recs_unit_type <- function(unit_type, map_title) {
  recs_housing_spatial %>%
    filter(housing_type == unit_type) %>%
    ggplot() +
    geom_sf(aes(fill = typeProportion)) +
    scale_fill_distiller(palette = "Purples",
                         direction = 1) +
    geom_sf(data = acs,
            color = "darkgray",
            fill = NA) +
    labs(title = map_title,
         fill = "Proportion of all \nhousing in region") +
    ggthemes::theme_map()
}
```


```{r}
map_recs_unit_type("Single family attached", "Proportion of Single Unit Attached Homes")

map_recs_unit_type("Single family detached", "Proportion of Single Unit Detached Homes")

map_recs_unit_type("Apt small building", "Proportion of 2-4 Unit Homes by Region")

map_recs_unit_type("Apt large building", "Proportion of 5+ Unit Homes by Region")
```

Single-unit detached homes dominate by region, although less so in New England, likely due to the presence of more compact cities like New York City. Single-unit attached and small apartments make up relatively larger proportions in New England, although are less common overall. Large apartments are common in New England and, interestingly, also the West- perhaps due to compact cities in California?



# What is the ACS estimate for distribution of housing type by state?

```{r}
# map housing type at the state level
map_acs_unit_type <- function(unit_type, map_title) {
  ggplot() +
    geom_sf(data = acs, aes(fill = {{unit_type}} / total_units)) +
    scale_fill_distiller(palette = "Oranges",
                         direction = 1) +
    labs(title = map_title,
         fill = "Proportion") +
    ggthemes::theme_map()
}
```


```{r}
single_unit_att <- map_acs_unit_type(unit_1_attached, "Proportion of Single Unit Attached Homes")

single_unit_det <- map_acs_unit_type(unit_1_detached, "Proportion of Single Unit Detached Homes")

small_apt <- map_acs_unit_type(units_2_4, "Proportion of Small Apartments (2-4 Unit)")

large_apt <- map_acs_unit_type(units_5_plus, "Proportion of Large Apartments (5+ Unit)")
```

```{r fig.height=8, fig.width=11, fig-mult-maps}
#| fig-cap: "Single unit houses, unsuprisingly, also dominate by state. They seem least prevalent in New York and Massachusets, and make up a somewhat lower proportion in Illinois, California, Nevada, and North Dakota. Pennsylvania and Maryland contain an intriguingly high proportion of single-unit attached houses. Over a fifth of Rhode Island's housing is small apartments; New York, Connecticut, and New Jersey also have high proportions. Although not visible, around half of D.C.'s housing is large apartments, followed by New York, supporting the idea that cities tend to contain larger unit housing."


units_by_state <- ggarrange(single_unit_det,
                            single_unit_att,
                            small_apt,
                            large_apt)

annotate_figure(
  units_by_state,
  top = text_grob(
    "Frequency of Housing Types by State, 2011-2015",
    face = "bold",
    size = 18
  )
)
```



#Who rents vs owns by state?
```{r}
ggplot() +
  geom_sf(data = acs, aes(fill = tenureOwned/tenureTotal)) +
  scale_fill_distiller(palette = "Greens",
                       direction = 1) +
  labs(title = "Who Owns Housing?",
       caption = "Data source: 2011-2015 5-year ACS, US Census Bureau",
       fill = "Proportion \nOwning") +
    ggthemes::theme_map()

ggplot() +
  geom_sf(data = acs, aes(fill = tenureRented/tenureTotal)) +
  scale_fill_distiller(palette = "Greens",
                       direction = 1) +
  labs(title = "Who Rents Housing?",
       caption = "Data source: 2011-2015 5-year ACS, US Census Bureau",
       fill = "Proportion \nRenting") +
    ggthemes::theme_map()
```
Generally, owning is more common then renting. The exceptions to this rule are New York, Calfornia, and Nevada- states with big cities. 


# What's the median age of buildings by state?
```{r}
ggplot() +
  geom_sf(data = acs, aes(fill = med_year_built)) +
    scale_fill_distiller(palette = "BuPu",
                       direction = -1) +
  labs(title = "Median Building Age, 2011-2015",
       caption = "Data source: 2011-2015 5-year ACS, US Census Bureau",
       fill = "Median Year Built") +
    ggthemes::theme_map()
```
Nevada has the newest buildings. Houses in the South and West generally tend to be newer. Houses in New York are oldest, along with several states in New England and the Midwest- notably Illinois, Iowa, and Ohio. 


```{r}
# Add geometry to a summary of a RECS variable and map it 
geom_map_var <- function(var, df, title, legend_title, palette) {
  data_geom <- region_geometry %>%
    left_join(df, join_by(region == region_name))
  
  ggplot() +
    geom_sf(data = data_geom, aes(fill = {{var}})) +
    scale_fill_distiller(palette = palette,
                         direction = 1) +
    geom_sf(data = acs,
            color = "darkgray",
            fill = NA) +
    labs(title = title,
         fill = legend_title) +
    ggthemes::theme_map()
}
```


## What regions' houses have air conditioning?
```{r}
recs_aircon <- recs %>%
  count(region_name, aircon) %>%
  group_by(region_name) %>%
  mutate(total = sum(n),
         proportion_aircon = n / total) %>%
  filter(aircon == "Yes")

aircon_choropleth <- geom_map_var(
  proportion_aircon,
  recs_aircon,
  "Proportion of Homes with Air Conditioning",
  "Propotion",
  "Blues"
)

aircon_choropleth
```
Air conditioning is nearly universal in the South, and is almost as common in the Midwest. Its prevalence drops to around 80% in New England, and down to 75% in the West. 

# Which regions use more energy?
```{r}
recs_tot_energy <- recs %>%
  group_by(region_name) %>%
  summarise(mean_tot_en = mean(TOTALBTU))

tot_energy_choropleth <- geom_map_var(
  mean_tot_en,
  recs_tot_energy,
  "Mean Energy Use by Region in 2015",
  "Mean Total Energy",
  "Reds"
) 

tot_energy_choropleth
```
New England and the Midwest overall use the most energy, followed by the South, with the West using least. 

## Which regions use more electricity?
```{r}
recs_btu <- recs %>% 
  group_by(region_name) %>% 
  summarise(mean_btu = mean(BTUEL)) 
 
 btu_choropleth <- geom_map_var(
  mean_btu,
  recs_btu,
  "Mean Electrity Usage by Region in 2015",
  "Mean Electricity \nUse (thousand \nBtu)",
  "Purples"
)
 
 btu_choropleth
```
The South uses noticeably more air conditioning than other regions. 


## What about natural gas?
```{r}
recs_btn <-recs %>% 
  group_by(region_name) %>% 
  summarise(mean_btn = mean(BTUNG)) 
 
btn_choropleth <- geom_map_var(
  mean_btn,
  recs_btn,
  "Mean Natural Gas Usage by Region in 2015",
  "Mean Natural \nGas Use\n(thousand Btu)",
  "Oranges"
) 

btn_choropleth
```
The Midwest uses notably more natural gas than other regions, followed by New England and the West.



# Multivariate Analysis

```{r}
btn_choropleth +
  geom_sf(data = centers, aes(size = med_year_built), color = "red") +
    scale_size(range = c(.5, 6)) +
  labs(size = "Median Year Built")
```

```{r}
recs_sqft <- recs %>%
  group_by(region_name) %>%
  summarise(mean_sqft = mean(TOTSQFT_EN))

sqft_choropleth <- geom_map_var(
  mean_sqft,
  recs_sqft,
  "Median Building Age and Square Footage of Residential Buildings by Region in 2015",
  "Mean Square Feet",
  "Purples"
) 

sqft_choropleth
```

```{r fig-age-sqft}
#| fig-cap: "Midwestern homes tend to be larger, followed by New England homes, which also tend to be older. The South and West have relatively newer and smaller homes."

sqft_choropleth +
  geom_sf(data = centers, aes(size = med_year_built), color = "blue") +
    scale_size(range = c(.5, 6)) +
  labs(size = "Median Year Built",
       caption = "Data sources: 2011-2015 ACS, US Census Bureau; 2015 RECS, US Energy Information Admininstration")
```

To do: 
-make a more general function for ggplot
